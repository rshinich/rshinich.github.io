<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="今天来看一下iOS中的多线程开发，iOS的多线程开发也有很多种方式，不得不提的有一个就是GCD了。在介绍他之前，先放上苹果官方的GCD源码。
GCD是什么GCD全称Grand Central Dispatch，是Apple开发的一个异步执行任务的技术之一，GCD将iOS系统中很复杂的多线程开发交给系统来做，开发者只需要定义想执行的任务并追加到适当的Dispatch Queue中就可以实现复杂的多线">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS开发-多线程GCD">
<meta property="og:url" content="http://yoursite.com/2018/03/21/iOS开发-多线程GCD/index.html">
<meta property="og:site_name" content="zhangzr's blog">
<meta property="og:description" content="今天来看一下iOS中的多线程开发，iOS的多线程开发也有很多种方式，不得不提的有一个就是GCD了。在介绍他之前，先放上苹果官方的GCD源码。
GCD是什么GCD全称Grand Central Dispatch，是Apple开发的一个异步执行任务的技术之一，GCD将iOS系统中很复杂的多线程开发交给系统来做，开发者只需要定义想执行的任务并追加到适当的Dispatch Queue中就可以实现复杂的多线">
<meta property="og:updated_time" content="2018-03-26T14:16:15.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS开发-多线程GCD">
<meta name="twitter:description" content="今天来看一下iOS中的多线程开发，iOS的多线程开发也有很多种方式，不得不提的有一个就是GCD了。在介绍他之前，先放上苹果官方的GCD源码。
GCD是什么GCD全称Grand Central Dispatch，是Apple开发的一个异步执行任务的技术之一，GCD将iOS系统中很复杂的多线程开发交给系统来做，开发者只需要定义想执行的任务并追加到适当的Dispatch Queue中就可以实现复杂的多线">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/03/21/iOS开发-多线程GCD/"/>





  <title> iOS开发-多线程GCD | zhangzr's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e4d9b18c740ec1cd356179a5fc16e0ba";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zhangzr's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/21/iOS开发-多线程GCD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangzr">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhangzr's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                iOS开发-多线程GCD
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-21T20:55:23+08:00">
                2018-03-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>今天来看一下iOS中的多线程开发，iOS的多线程开发也有很多种方式，不得不提的有一个就是<strong>GCD</strong>了。在介绍他之前，先放上苹果官方的<a href="https://apple.github.io/swift-corelibs-libdispatch/" target="_blank" rel="external">GCD源码</a>。</p>
<h2 id="GCD是什么"><a href="#GCD是什么" class="headerlink" title="GCD是什么"></a>GCD是什么</h2><p>GCD全称Grand Central Dispatch，是Apple开发的一个异步执行任务的技术之一，GCD将iOS系统中很复杂的多线程开发交给系统来做，开发者只需要定义想执行的任务并追加到适当的Dispatch Queue中就可以实现复杂的多线程开发了。</p>
<h2 id="多线程编程"><a href="#多线程编程" class="headerlink" title="多线程编程"></a>多线程编程</h2><p>介绍GCD的使用之前，我们先来复习一下多线程编程中的一些概念。</p>
<h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>进程是程序在计算机上一次执行的活动，在iOS中，一般来说，一个App就是一个进程，进程可以向系统要求一块内存空间，一个进程可以包含多个线程。</p>
<h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p>线程是一个独立执行代码段，一个线程同时间内只能执行一个任务，所以多线程并发就可以在同一时间执行多个任务。</p>
<h3 id="主线程"><a href="#主线程" class="headerlink" title="主线程"></a>主线程</h3><p>在iOS中，主线程主要的任务是处理UI事件，所以又叫做UI线程，只有主线程才有负责修改UI的能力，而耗时的操作（加载网络资源、上传文件）一般都放在子线程中，但是开辟子线程会占用一定系统资源，所以一般不要同时开特别多线程。</p>
<h3 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h3><p>任务一般指的是需要执行的操作，也就是说线程中执行的那段代码。</p>
<h3 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h3><p>同步（sync）一般是指当任务添加到执行任务的队列中时，如果队列中有其他先进入的任务，就会一直等待，直到之前的任务都执行完成后才执行。</p>
<p>同步执行任务只能在当前线程中执行任务，不具备开启新线程的能力。</p>
<h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>异步（async）一般是指当任务添加到执行任务的队列中时，不做任何的等待，直接执行任务。</p>
<p>异步执行任务可以在新的线程中执行任务，具备开启新线程的能力。（但是是否开启新线程跟任务所指定的队列有关）</p>
<h3 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h3><p>这里的队列指的是执行任务的等待队列，即用来存放任务的队列。队列是一种特殊的线性表，采用FIFO（先进先出）的原则，新的任务总是被添加到队尾，读取任务总是从队头读取。</p>
<h3 id="串行"><a href="#串行" class="headerlink" title="串行"></a>串行</h3><p>串行队列中每次只会有一个任务被执行。只开启一个线程，一个任务执行完毕后，才执行下一个任务。</p>
<h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><p>并发队列可以让多个任务同时执行。并发队列只有在异步时才会有效。</p>
<h2 id="GCD的使用"><a href="#GCD的使用" class="headerlink" title="GCD的使用"></a>GCD的使用</h2><p>苹果的官方说明中说过：</p>
<blockquote>
<p>开发者只需要定义想执行的任务并追加到适当的 Dispatch Queue中，GCD就能生成必要的线程并计划执行任务。</p>
</blockquote>
<p>也就是说GCD的使用只需要两个步骤：</p>
<ul>
<li>1.找到适当的等待队列。</li>
<li>2.将任务追加到等待队列中。</li>
</ul>
<h3 id="找到适当的等待队列"><a href="#找到适当的等待队列" class="headerlink" title="找到适当的等待队列"></a>找到适当的等待队列</h3><p>找打适当的等待队列有两种方法，一种是通过<code>dispatch_queue_create</code>方法生成Dispatch Queue，还有一种是获取系统提供的Dispatch Queue。</p>
<h4 id="dispatch-queue-create"><a href="#dispatch-queue-create" class="headerlink" title="dispatch_queue_create"></a>dispatch_queue_create</h4><p>使用<code>dispatch_queue_create</code>函数创建队列，需要传入两个参数，第一个作为队列的唯一标示符，可以为空，第二个参数用来识别队列为串行队列还是并发队列。</p>
<ul>
<li>DISPATCH_QUEUE_SERIAL 串行队列</li>
<li>DISPATCH_QUEUE_CONCURRENT 并发队列</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> 创建串行队列</div><div class="line"> */</div><div class="line"></div><div class="line">- (void)createSerialQueue</div><div class="line">&#123;</div><div class="line">    dispatch_queue_t serialQueue = dispatch_queue_create(&quot;cn.zhangzr.gcdDemo&quot;, DISPATCH_QUEUE_SERIAL);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> 创建并发队列</div><div class="line"> */</div><div class="line"></div><div class="line">- (void)createConcurrentQueue</div><div class="line">&#123;</div><div class="line">    dispatch_queue_t concurrentQueue = dispatch_queue_create(&quot;cn.zhangzr.gcdDemo&quot;, DISPATCH_QUEUE_CONCURRENT);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Main-Dispatch-Queue-（主队列）"><a href="#Main-Dispatch-Queue-（主队列）" class="headerlink" title="Main Dispatch Queue （主队列）"></a>Main Dispatch Queue （主队列）</h4><p>实际上我们可以不用可以创建队列，系统也会给我们一共一些队列，Main Dispatch Queue就是其中一个，看名字就能看的出，一个<strong>Main</strong>出卖了他是在主线程中执行的身份，因为主线程只会有一个，所以Main Dispatch Queue就是串行队列。</p>
<p>获取他可以通过使用<code>dispatch_get_main_queue()</code>方法获取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> 获取主队列</div><div class="line"> */</div><div class="line"></div><div class="line">- (void)getMainQueue</div><div class="line">&#123;</div><div class="line">    dispatch_queue_t mainQueue = dispatch_get_main_queue();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Global-Dispatch-Queue（全局并发队列）"><a href="#Global-Dispatch-Queue（全局并发队列）" class="headerlink" title="Global Dispatch Queue（全局并发队列）"></a>Global Dispatch Queue（全局并发队列）</h4><p>有了系统提供的串行队列，我们再看看另一个由系统提供的并发队列 Global Dispatch Queue，全局并发队列，它是所有应用程序都能够使用的并发队列。</p>
<p>获取他可以通过使用<code>dispatch_get_global_queue()</code>方法获取，需要提供两个参数，第一个参数为优先级，分为：</p>
<ul>
<li>DISPATCH_QUEUE_PRIORITY_HIGH 最高优先级</li>
<li>DISPATCH_QUEUE_PRIORITY_DEFAULT 默认优先级</li>
<li>DISPATCH_QUEUE_PRIORITY_LOW 低优先级</li>
<li>DISPATCH_QUEUE_PRIORITY_BACKGROUND 后台优先级</li>
</ul>
<p>第二个参数暂时没用，传入<code>0</code>即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> 获取全局队列</div><div class="line"> */</div><div class="line"></div><div class="line">- (void)getGlobalQueue</div><div class="line">&#123;</div><div class="line">    dispatch_queue_t globalQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="将任务追加到等待队列中"><a href="#将任务追加到等待队列中" class="headerlink" title="将任务追加到等待队列中"></a>将任务追加到等待队列中</h3><p>GCD提供了同步执行任务的创建方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//同步执行</div><div class="line">dispatch_sync(queue, ^&#123;</div><div class="line">    do something...</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>和异步执行任务的创建方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//异步执行</div><div class="line">dispatch_async(queue, ^&#123;</div><div class="line">    do something...</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="GCD的使用实例"><a href="#GCD的使用实例" class="headerlink" title="GCD的使用实例"></a>GCD的使用实例</h2><p>通过上边的介绍我们大概知道了有两种队列和两种任务的执行方式，排列组合一下就有如下4中结果</p>
<ul>
<li>1.同步执行 + 并发队列</li>
<li>2.异步执行 + 并发队列</li>
<li>3.同步执行 + 串行队列</li>
<li>4.异步执行 + 串行队列</li>
</ul>
<p>另外我们还介绍了两种系统提供的队列的获取方式，全局并发队列可以作为一种普通的并发队列考虑，但是主队列这里有一些特殊，所以我们单独来讨论他。那么就再加上两种组合。</p>
<ul>
<li>5.同步执行 + 主队列</li>
<li>6.异步执行 + 主队列</li>
</ul>
<p>那么接下来我们就一一来看一下这些组合的实现</p>
<h3 id="同步执行-并发队列"><a href="#同步执行-并发队列" class="headerlink" title="同步执行 + 并发队列"></a>同步执行 + 并发队列</h3><p>我们先来执行如下代码看看结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">- (void)syncConcurrent</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;current thread---:%@&quot;,[NSThread currentThread]);        //打印当前线程</div><div class="line">    </div><div class="line">    NSLog(@&quot;syncConcurrent---begin&quot;);</div><div class="line">    </div><div class="line">    dispatch_queue_t queue = dispatch_queue_create(&quot;syncConcurrent&quot;, DISPATCH_QUEUE_CONCURRENT);</div><div class="line">    </div><div class="line">    dispatch_sync(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;1---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_sync(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;2---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    </div><div class="line">    dispatch_sync(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;3---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    NSLog(@&quot;syncConcurrent---end&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2018-03-22 20:22:07.869051+0800 GCDDemo[14040:14475252] current thread---:&lt;NSThread: 0x604000071a80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:22:07.869227+0800 GCDDemo[14040:14475252] syncConcurrent---begin</div><div class="line">2018-03-22 20:22:09.870422+0800 GCDDemo[14040:14475252] 1---:&lt;NSThread: 0x604000071a80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:22:11.870946+0800 GCDDemo[14040:14475252] 1---:&lt;NSThread: 0x604000071a80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:22:13.871345+0800 GCDDemo[14040:14475252] 2---:&lt;NSThread: 0x604000071a80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:22:15.872180+0800 GCDDemo[14040:14475252] 2---:&lt;NSThread: 0x604000071a80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:22:17.873334+0800 GCDDemo[14040:14475252] 3---:&lt;NSThread: 0x604000071a80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:22:19.873793+0800 GCDDemo[14040:14475252] 3---:&lt;NSThread: 0x604000071a80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:22:19.874091+0800 GCDDemo[14040:14475252] syncConcurrent---end</div></pre></td></tr></table></figure>
<p>我们可以看到，所有的任务都是在当前线程中执行的，任务的过程中没有开启新的线程。</p>
<p>另外所有的任务都是在begin和end之间执行的。</p>
<p>尽管并发是不需要等待前一个任务结束就可以开始执行，但是因为同步不具备开启线程的功能，所以也只会有一个线程，所以并发也就不存在了。任务只能一个接一个的执行。</p>
<h3 id="异步执行-并发队列"><a href="#异步执行-并发队列" class="headerlink" title="异步执行 + 并发队列"></a>异步执行 + 并发队列</h3><p>先看示例代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">- (void)asyncConcurrent</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;current thread---:%@&quot;,[NSThread currentThread]);        //打印当前线程</div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncConcurrent---begin&quot;);</div><div class="line">    </div><div class="line">    dispatch_queue_t queue = dispatch_queue_create(&quot;asyncConcurrent&quot;, DISPATCH_QUEUE_CONCURRENT);</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;1---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;2---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;3---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncConcurrent---end&quot;);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再看打印结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2018-03-22 20:26:46.828393+0800 GCDDemo[14132:14488888] current thread---:&lt;NSThread: 0x604000075d00&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:26:46.828575+0800 GCDDemo[14132:14488888] asyncConcurrent---begin</div><div class="line">2018-03-22 20:26:46.828700+0800 GCDDemo[14132:14488888] asyncConcurrent---end</div><div class="line">2018-03-22 20:26:48.834176+0800 GCDDemo[14132:14488952] 3---:&lt;NSThread: 0x604000274700&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-22 20:26:48.834180+0800 GCDDemo[14132:14488951] 2---:&lt;NSThread: 0x600000277dc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-22 20:26:48.834180+0800 GCDDemo[14132:14488949] 1---:&lt;NSThread: 0x600000461300&gt;&#123;number = 5, name = (null)&#125;</div><div class="line">2018-03-22 20:26:50.838816+0800 GCDDemo[14132:14488949] 1---:&lt;NSThread: 0x600000461300&gt;&#123;number = 5, name = (null)&#125;</div><div class="line">2018-03-22 20:26:50.838818+0800 GCDDemo[14132:14488952] 3---:&lt;NSThread: 0x604000274700&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-22 20:26:50.838831+0800 GCDDemo[14132:14488951] 2---:&lt;NSThread: 0x600000277dc0&gt;&#123;number = 4, name = (null)&#125;</div></pre></td></tr></table></figure>
<p>可以明显的看到，这次的结果和上次的结果有很大的不同，首先，任务的过程中开启了很多新的线程。</p>
<p>还有，所有的任务都没有在begin和end之间执行，而是在end之后才执行。</p>
<p>说明异步执行是具备开启线程的能力，并且没有等待之前的任务结束，就继续执行任务了。</p>
<h3 id="同步执行-串行队列"><a href="#同步执行-串行队列" class="headerlink" title="同步执行 + 串行队列"></a>同步执行 + 串行队列</h3><p>先看代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">- (void)syncSerial</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;current thread---:%@&quot;,[NSThread currentThread]);        //打印当前线程</div><div class="line">    </div><div class="line">    NSLog(@&quot;syncSerial---begin&quot;);</div><div class="line">    </div><div class="line">    dispatch_queue_t queue = dispatch_queue_create(&quot;syncSerial&quot;, DISPATCH_QUEUE_SERIAL);</div><div class="line">    </div><div class="line">    dispatch_sync(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;1---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_sync(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;2---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">    dispatch_sync(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;3---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    NSLog(@&quot;syncSerial---end&quot;);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再看打印的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2018-03-22 20:32:44.564374+0800 GCDDemo[14261:14507367] current thread---:&lt;NSThread: 0x6040000781c0&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:32:44.564535+0800 GCDDemo[14261:14507367] syncSerial---begin</div><div class="line">2018-03-22 20:32:46.566058+0800 GCDDemo[14261:14507367] 1---:&lt;NSThread: 0x6040000781c0&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:32:48.567670+0800 GCDDemo[14261:14507367] 1---:&lt;NSThread: 0x6040000781c0&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:32:50.568163+0800 GCDDemo[14261:14507367] 2---:&lt;NSThread: 0x6040000781c0&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:32:52.569652+0800 GCDDemo[14261:14507367] 2---:&lt;NSThread: 0x6040000781c0&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:32:54.571255+0800 GCDDemo[14261:14507367] 3---:&lt;NSThread: 0x6040000781c0&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:32:56.572867+0800 GCDDemo[14261:14507367] 3---:&lt;NSThread: 0x6040000781c0&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:32:56.573196+0800 GCDDemo[14261:14507367] syncSerial---end</div></pre></td></tr></table></figure>
<p>我们可以看到，这次的任务打印结果和第一次异步执行 + 并发队列的结果基本相同，所有的任务都是在主线程执行的，没有开启新的子线程。</p>
<p>并且所有的任务都是在begin和end之间一个一个按顺序执行的。</p>
<h3 id="异步执行-串行队列"><a href="#异步执行-串行队列" class="headerlink" title="异步执行 + 串行队列"></a>异步执行 + 串行队列</h3><p>还是先看代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">- (void)asyncSerial</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;current thread---:%@&quot;,[NSThread currentThread]);        //打印当前线程</div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncSerial---begin&quot;);</div><div class="line">    </div><div class="line">    dispatch_queue_t queue = dispatch_queue_create(&quot;syncSerial&quot;, DISPATCH_QUEUE_SERIAL);</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;1---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;2---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;3---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncSerial---end&quot;);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再看结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2018-03-22 20:36:30.829895+0800 GCDDemo[14342:14518025] current thread---:&lt;NSThread: 0x60000007fe80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:36:30.830061+0800 GCDDemo[14342:14518025] asyncSerial---begin</div><div class="line">2018-03-22 20:36:30.830210+0800 GCDDemo[14342:14518025] asyncSerial---end</div><div class="line">2018-03-22 20:36:32.832667+0800 GCDDemo[14342:14518069] 1---:&lt;NSThread: 0x60400027d100&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-22 20:36:34.838401+0800 GCDDemo[14342:14518069] 1---:&lt;NSThread: 0x60400027d100&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-22 20:36:36.844076+0800 GCDDemo[14342:14518069] 2---:&lt;NSThread: 0x60400027d100&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-22 20:36:38.849738+0800 GCDDemo[14342:14518069] 2---:&lt;NSThread: 0x60400027d100&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-22 20:36:40.855311+0800 GCDDemo[14342:14518069] 3---:&lt;NSThread: 0x60400027d100&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-22 20:36:42.855999+0800 GCDDemo[14342:14518069] 3---:&lt;NSThread: 0x60400027d100&gt;&#123;number = 3, name = (null)&#125;</div></pre></td></tr></table></figure>
<p>我们可以看到，所有的任务都是在begin和end之后执行的，并且开启了一条新的线程。</p>
<p>但是因为是串行任务，所以所有的任务还是都是按照顺序一个一个执行的。</p>
<h3 id="同步执行-主队列"><a href="#同步执行-主队列" class="headerlink" title="同步执行 + 主队列"></a>同步执行 + 主队列</h3><p>先看代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">- (void)syncMain</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;current thread---:%@&quot;,[NSThread currentThread]);        //打印当前线程</div><div class="line">    </div><div class="line">    NSLog(@&quot;syncMain---begin&quot;);</div><div class="line">    </div><div class="line">    dispatch_queue_t queue = dispatch_get_main_queue();</div><div class="line">    </div><div class="line">    dispatch_sync(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;1---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_sync(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;2---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">    dispatch_sync(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;3---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    NSLog(@&quot;syncMain---end&quot;);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再看结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2018-03-22 20:39:58.718404+0800 GCDDemo[14415:14527628] current thread---:&lt;NSThread: 0x60400007af80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:39:58.718631+0800 GCDDemo[14415:14527628] syncMain---begin</div><div class="line">(lldb)</div></pre></td></tr></table></figure>
<p>这时候我们会发现，程序走到begin之后就没有再往下进行了，而且还发生了崩溃。</p>
<p>原因就是我们在主线程中执行了<code>syncMain</code>方法，相当于把<code>syncMain</code>放到了主线程的队列中，但是同步执行的方式会等到当前队列中的任务执行完毕，才会接着执行，这时候我们又把1号任务追加到主线程中，1号任务就在等待主线程处理完<code>syncMain</code>的任务，而<code>syncMain</code>需要等待1号任务执行完毕，才能继续进行。</p>
<p>那这时候就出现了死锁的问题，大家互相等待，所以就都没办法执行下去了。</p>
<p>那如果我们不再主线程中调用呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[NSThread detachNewThreadSelector:@selector(syncMain) toTarget:self withObject:nil];</div></pre></td></tr></table></figure>
<p>再看结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2018-03-22 20:48:02.987608+0800 GCDDemo[14560:14544489] current thread---:&lt;NSThread: 0x604000467680&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-22 20:48:02.987778+0800 GCDDemo[14560:14544489] syncMain---begin</div><div class="line">2018-03-22 20:48:04.992144+0800 GCDDemo[14560:14544241] 1---:&lt;NSThread: 0x600000261b00&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:48:06.993744+0800 GCDDemo[14560:14544241] 1---:&lt;NSThread: 0x600000261b00&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:48:08.995656+0800 GCDDemo[14560:14544241] 2---:&lt;NSThread: 0x600000261b00&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:48:10.996423+0800 GCDDemo[14560:14544241] 2---:&lt;NSThread: 0x600000261b00&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:48:12.999316+0800 GCDDemo[14560:14544241] 3---:&lt;NSThread: 0x600000261b00&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:48:15.000457+0800 GCDDemo[14560:14544241] 3---:&lt;NSThread: 0x600000261b00&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:48:15.003178+0800 GCDDemo[14560:14544489] syncMain---end</div></pre></td></tr></table></figure>
<p>这时候我们发现，一切又可以很好的运行起来了，而且都是在主线程中一个一个按照顺序执行的。</p>
<p>那为什么这时候不会发生死锁问题呢？</p>
<p>是因为<code>syncMain</code>放到了其他的线程中，而1号任务、2号任务和3号任务都被追加到了主线程中，这三个任务都会在主线程中执行，而<code>syncMain</code>则是在另外一个子线程中执行的，这时候主队列中就没有等待执行的任务，所以就会直接执行1号任务，所以不会发生死锁。</p>
<h3 id="异步执行-主线程"><a href="#异步执行-主线程" class="headerlink" title="异步执行 + 主线程"></a>异步执行 + 主线程</h3><p>接下来我们看一下异步执行 + 主线程的情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">- (void)asyncMain</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;current thread---:%@&quot;,[NSThread currentThread]);        //打印当前线程</div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncMain---begin&quot;);</div><div class="line">    </div><div class="line">    dispatch_queue_t queue = dispatch_get_main_queue();</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;1---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;2---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                  //模拟耗时操作</div><div class="line">            NSLog(@&quot;3---:%@&quot;,[NSThread currentThread]);         //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncMain---end&quot;);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再看打印的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2018-03-22 20:53:36.799541+0800 GCDDemo[14659:14556655] current thread---:&lt;NSThread: 0x600000076d80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:53:36.799729+0800 GCDDemo[14659:14556655] asyncMain---begin</div><div class="line">2018-03-22 20:53:36.799843+0800 GCDDemo[14659:14556655] asyncMain---end</div><div class="line">2018-03-22 20:53:38.804826+0800 GCDDemo[14659:14556655] 1---:&lt;NSThread: 0x600000076d80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:53:40.805504+0800 GCDDemo[14659:14556655] 1---:&lt;NSThread: 0x600000076d80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:53:42.807095+0800 GCDDemo[14659:14556655] 2---:&lt;NSThread: 0x600000076d80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:53:44.808701+0800 GCDDemo[14659:14556655] 2---:&lt;NSThread: 0x600000076d80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:53:46.809607+0800 GCDDemo[14659:14556655] 3---:&lt;NSThread: 0x600000076d80&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-22 20:53:48.811117+0800 GCDDemo[14659:14556655] 3---:&lt;NSThread: 0x600000076d80&gt;&#123;number = 1, name = main&#125;</div></pre></td></tr></table></figure>
<p>可以看到，所有的任务都会追加到主线程中来执行，但是都会是在end之后，也就是说不会等待之前的任务完成就会继续后边的任务，但是因为所有的任务都被追加到主线程这一条线程中执行，是串行队列，所以任务都是一个接一个的按顺序执行的。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>6种组合方法都已经使用过了，接下来让我们来列个表格总结一下吧。</p>
<table>
<thead>
<tr>
<th></th>
<th>并发队列</th>
<th>串行队列</th>
<th>主队列</th>
</tr>
</thead>
<tbody>
<tr>
<td>同步</td>
<td>不开启新线程，串行执行任务</td>
<td>不开启新线程，串行执行任务</td>
<td>主线程调用：发生死锁，卡死。其他线程调用：不开启新线程，串行执行任务</td>
</tr>
<tr>
<td>异步</td>
<td>开启新线程，并发执行任务</td>
<td>开启一条新线程，串行执行任务</td>
<td>不开启新线程，串行执行任务</td>
</tr>
</tbody>
</table>
<h2 id="GCD-的其他API"><a href="#GCD-的其他API" class="headerlink" title="GCD 的其他API"></a>GCD 的其他API</h2><p>除了刚才介绍过的<code>dispatch_queue_create()</code>、<code>dispatch_sync()</code>、<code>dispatch_async()</code>…之外，GCD的作用还有很多，接下来我们就来看看GCD的其他方法。</p>
<h3 id="dispatch-set-target-queue"><a href="#dispatch-set-target-queue" class="headerlink" title="dispatch_set_target_queue"></a>dispatch_set_target_queue</h3><p>这个函数主要有两个作用：</p>
<ul>
<li>1.改变队列的优先级；</li>
<li>2.防止多个串行队列并发执行；</li>
</ul>
<h4 id="改变队列的优先级"><a href="#改变队列的优先级" class="headerlink" title="改变队列的优先级"></a>改变队列的优先级</h4><p>使用 dispatch_queue_create函数生成的队列，无论是串行的还是并发的，都是与默认优先级Global Dispatch Queue一致。</p>
<p>如果想要改变队列的优先级，就需要使用到dispatch_set_target_queue。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dispatch_set_target_queue(dispatch_object_t  _Nonnull object, dispatch_queue_t  _Nullable queue)</div></pre></td></tr></table></figure>
<p>第一个参数：需要改变优先级的队列；<br>第二个参数：指定要执行的目标队列；</p>
<p>举个例子：</p>
<p>生成一个后台的串行队列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (void)changeQueue</div><div class="line">&#123;</div><div class="line">    dispatch_queue_t serialQueue = dispatch_queue_create(&quot;com.example.gcd&quot;, NULL);</div><div class="line">    dispatch_queue_t globalBackgroundQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, 0);</div><div class="line">    </div><div class="line">    //修改优先级为后台串行队列</div><div class="line">    dispatch_set_target_queue(serialQueue, globalBackgroundQueue);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="防止多个串行队列并发执行"><a href="#防止多个串行队列并发执行" class="headerlink" title="防止多个串行队列并发执行"></a>防止多个串行队列并发执行</h4><p>我们还可以使用dispatch_set_target_queue函数将目标函数指定为某个串行队列(Serial Dispatch Queue)，就可以防止这些处理并发执行。</p>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">- (void)changeQueue2</div><div class="line">&#123;</div><div class="line">    NSMutableArray *queueArr = [NSMutableArray array];</div><div class="line">    </div><div class="line">    for(NSInteger i = 0 ; i &lt; 5 ; i++)</div><div class="line">    &#123;</div><div class="line">        dispatch_queue_t serial_queue = dispatch_queue_create(&quot;com.example.gcd.changeQueue2&quot;, NULL);</div><div class="line">        [queueArr addObject:serial_queue];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    [queueArr enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</div><div class="line">        </div><div class="line">        dispatch_queue_t serial_queue = obj;</div><div class="line">        </div><div class="line">        dispatch_async(serial_queue, ^&#123;</div><div class="line">            </div><div class="line">            NSLog(@&quot;执行任务%ld&quot;,idx);</div><div class="line">            </div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">2018-03-26 16:27:10.890910+0800 GCDDemo[1501:115539] 执行任务1</div><div class="line">2018-03-26 16:27:10.890910+0800 GCDDemo[1501:115541] 执行任务0</div><div class="line">2018-03-26 16:27:10.890910+0800 GCDDemo[1501:115540] 执行任务2</div><div class="line">2018-03-26 16:27:10.890968+0800 GCDDemo[1501:115542] 执行任务3</div><div class="line">2018-03-26 16:27:10.891012+0800 GCDDemo[1501:115561] 执行任务4</div></pre></td></tr></table></figure>
<p>这段代码运行了之后我们会发现，串行队列没有按照顺序一个一个执行。</p>
<p>接下来，我们添加一个目标队列之后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">- (void)changeQueue2</div><div class="line">&#123;</div><div class="line">    NSMutableArray *queueArr = [NSMutableArray array];</div><div class="line">    </div><div class="line">    //创建一个目标队列</div><div class="line">    dispatch_queue_t serial_target_queue = dispatch_queue_create(&quot;com.example.gcd.changeQueueTarget&quot;, NULL);</div><div class="line">    </div><div class="line">    for(NSInteger i = 0 ; i &lt; 5 ; i++)</div><div class="line">    &#123;</div><div class="line">        dispatch_queue_t serial_queue = dispatch_queue_create(&quot;com.example.gcd.changeQueue2&quot;, NULL);</div><div class="line">        </div><div class="line">        //添加目标队列</div><div class="line">        dispatch_set_target_queue(serial_queue, serial_target_queue);</div><div class="line">        [queueArr addObject:serial_queue];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    [queueArr enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</div><div class="line">        </div><div class="line">        dispatch_queue_t serial_queue = obj;</div><div class="line">        </div><div class="line">        dispatch_async(serial_queue, ^&#123;</div><div class="line">            </div><div class="line">            NSLog(@&quot;执行任务%ld&quot;,idx);</div><div class="line">            </div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到任务就按照我们的添加顺序执行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">2018-03-26 16:30:29.610249+0800 GCDDemo[1566:120853] 执行任务0</div><div class="line">2018-03-26 16:30:29.610430+0800 GCDDemo[1566:120853] 执行任务1</div><div class="line">2018-03-26 16:30:29.610565+0800 GCDDemo[1566:120853] 执行任务2</div><div class="line">2018-03-26 16:30:29.610678+0800 GCDDemo[1566:120853] 执行任务3</div><div class="line">2018-03-26 16:30:29.611625+0800 GCDDemo[1566:120853] 执行任务4</div></pre></td></tr></table></figure>
<h3 id="dispatch-after"><a href="#dispatch-after" class="headerlink" title="dispatch_after"></a>dispatch_after</h3><p>这个函数可以用来延迟执行block中的代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</div><div class="line">    </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>一般情况下，我们只需要修改<code>delayInSeconds</code>就可以了。</p>
<p>举个例子：</p>
<p>比如我想要3秒之后执行某个事情</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (void)afterRun</div><div class="line">&#123;</div><div class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</div><div class="line">        </div><div class="line">        //写你要做的事情</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是这里需要<strong>注意</strong>一点，这里的时间不是绝对的3秒后，而是在3秒后追加到Dispatch Queue中，效果和在3秒后使用dispatch_async追加到Main Queue效果相同。</p>
<p>因为Main Dispatch Queue是在主线程的RunLoop中执行的，所以在比如每个1/60秒执行的RunLoop中，block最快在3秒后执行，最慢在3+1/60秒后执行。但是如果主线程本身有延迟的话，这个时间就会更长一些了。</p>
<h3 id="dispatch-once"><a href="#dispatch-once" class="headerlink" title="dispatch_once"></a>dispatch_once</h3><p>这个函数可以用来保证在应用程序执行中只执行一次操作。一般在创建单例的时候经常使用，即使在多线程的情况下，也能保证线程的安全。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)runOnce</div><div class="line">&#123;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        //写你要做的事情</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="dispatch-group"><a href="#dispatch-group" class="headerlink" title="dispatch_group"></a>dispatch_group</h3><p>这个函数一般用来实现这样的需求，有三个耗时任务A、B、C，其中C需要等A和B异步执行完之后才能执行。这个时候我们就可以用到队列组来实现。</p>
<p>队列组中有三种方法能够实现这样的需求。</p>
<ul>
<li>1.使用 dispatch_group_notify</li>
<li>2.使用 dispatch_group_wait</li>
<li>3.使用 dispatch_group_enter,dispatch_group_leave</li>
</ul>
<h4 id="dispatch-group-notify"><a href="#dispatch-group-notify" class="headerlink" title="dispatch_group_notify"></a>dispatch_group_notify</h4><p>这个方法可以监听group中任务的完成状态，当所有的任务都执行完成之后，追加任务到group中，并执行任务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">- (void)groupNotify</div><div class="line">&#123;</div><div class="line">    </div><div class="line">    NSLog(@&quot;current thread---:%@&quot;,[NSThread currentThread]);        //打印当前线程</div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncMain---begin&quot;);</div><div class="line">    </div><div class="line">    dispatch_group_t group = dispatch_group_create();</div><div class="line">    </div><div class="line">    dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务A---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务B---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    dispatch_group_notify(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务C---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncMain---end&quot;);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2018-03-26 17:31:06.806883+0800 GCDDemo[2244:190058] current thread---:&lt;NSThread: 0x604000077980&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-26 17:31:06.807055+0800 GCDDemo[2244:190058] asyncMain---begin</div><div class="line">2018-03-26 17:31:06.807225+0800 GCDDemo[2244:190058] asyncMain---end</div><div class="line">2018-03-26 17:31:08.807669+0800 GCDDemo[2244:190117] 任务A---:&lt;NSThread: 0x60400027e280&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 17:31:08.807669+0800 GCDDemo[2244:190114] 任务B---:&lt;NSThread: 0x60400027e2c0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 17:31:10.813329+0800 GCDDemo[2244:190117] 任务A---:&lt;NSThread: 0x60400027e280&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 17:31:10.813329+0800 GCDDemo[2244:190114] 任务B---:&lt;NSThread: 0x60400027e2c0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 17:31:12.817688+0800 GCDDemo[2244:190114] 任务C---:&lt;NSThread: 0x60400027e2c0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 17:31:14.818356+0800 GCDDemo[2244:190114] 任务C---:&lt;NSThread: 0x60400027e2c0&gt;&#123;number = 4, name = (null)&#125;</div></pre></td></tr></table></figure>
<p>可以看到，任务A和任务B是异步的，没有按照顺序执行，但是任务C是在A和B都结束之后才开始执行的。</p>
<h4 id="dispatch-group-wait"><a href="#dispatch-group-wait" class="headerlink" title="dispatch_group_wait"></a>dispatch_group_wait</h4><p>这个方法可以阻塞当前线程，等待group中的任务全部完成之后，才会继续往下执行。</p>
<p>这里边的第二个参数用来表示阻塞当前线程的时间，如果传入<code>DISPATCH_TIME_FOREVER</code>则表示永远，直到group中的任务执行完毕。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">- (void)groupWait</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;current thread---:%@&quot;,[NSThread currentThread]);        //打印当前线程</div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncMain---begin&quot;);</div><div class="line"></div><div class="line">    dispatch_group_t group = dispatch_group_create();</div><div class="line">    </div><div class="line">    </div><div class="line">    dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务A---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务B---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">    dispatch_group_wait(group,  DISPATCH_TIME_FOREVER);</div><div class="line"></div><div class="line">    </div><div class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务C---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line"></div><div class="line">    </div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncMain---end&quot;);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2018-03-26 17:44:11.898008+0800 GCDDemo[2420:207859] current thread---:&lt;NSThread: 0x60400007ebc0&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-26 17:44:11.898194+0800 GCDDemo[2420:207859] asyncMain---begin</div><div class="line">2018-03-26 17:44:13.903195+0800 GCDDemo[2420:207951] 任务A---:&lt;NSThread: 0x604000478940&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 17:44:13.903213+0800 GCDDemo[2420:207954] 任务B---:&lt;NSThread: 0x604000478740&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 17:44:15.904134+0800 GCDDemo[2420:207951] 任务A---:&lt;NSThread: 0x604000478940&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 17:44:15.904177+0800 GCDDemo[2420:207954] 任务B---:&lt;NSThread: 0x604000478740&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 17:44:15.904431+0800 GCDDemo[2420:207859] asyncMain---end</div><div class="line">2018-03-26 17:44:17.909766+0800 GCDDemo[2420:207954] 任务C---:&lt;NSThread: 0x604000478740&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 17:44:19.911876+0800 GCDDemo[2420:207954] 任务C---:&lt;NSThread: 0x604000478740&gt;&#123;number = 3, name = (null)&#125;</div></pre></td></tr></table></figure>
<h4 id="dispatch-group-enter-dispatch-group-leave"><a href="#dispatch-group-enter-dispatch-group-leave" class="headerlink" title="dispatch_group_enter + dispatch_group_leave"></a>dispatch_group_enter + dispatch_group_leave</h4><p>dispatch_group_enter 表示将一个任务追加到了group中，执行一次，则表示group中未完成的任务+1；</p>
<p>dispatch_group_leave 表示一个任务离开了group中，执行一次，则表示group中未完成的任务-1；</p>
<p>当group中未完成的任务数为0的时候，才会开始执行下边的任务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">- (void)groupEnterLeave</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;current thread---:%@&quot;,[NSThread currentThread]);        //打印当前线程</div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncMain---begin&quot;);</div><div class="line">    </div><div class="line">    </div><div class="line">    dispatch_group_t group = dispatch_group_create();</div><div class="line">    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</div><div class="line">    </div><div class="line">    dispatch_group_enter(group);</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务A---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        dispatch_group_leave(group);</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_group_enter(group);</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务B---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        dispatch_group_leave(group);</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line"></div><div class="line">    dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务C---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">   </div><div class="line">    /**</div><div class="line">     或者使用</div><div class="line">     </div><div class="line">     dispatch_group_wait(group,  DISPATCH_TIME_FOREVER);</div><div class="line">     </div><div class="line">     </div><div class="line">     dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">     </div><div class="line">     for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">     &#123;</div><div class="line">     [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">     NSLog(@&quot;任务C---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">     &#125;</div><div class="line">     &#125;);</div><div class="line">     </div><div class="line">     */</div><div class="line"></div><div class="line">    </div><div class="line">    NSLog(@&quot;asyncMain---end&quot;);</div><div class="line">    </div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2018-03-26 17:51:20.854245+0800 GCDDemo[2536:218929] current thread---:&lt;NSThread: 0x6000000646c0&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-26 17:51:20.854413+0800 GCDDemo[2536:218929] asyncMain---begin</div><div class="line">2018-03-26 17:51:20.854603+0800 GCDDemo[2536:218929] asyncMain---end</div><div class="line">2018-03-26 17:51:22.859505+0800 GCDDemo[2536:219069] 任务A---:&lt;NSThread: 0x60000007a5c0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 17:51:22.859505+0800 GCDDemo[2536:219072] 任务B---:&lt;NSThread: 0x60400026bf00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 17:51:24.862088+0800 GCDDemo[2536:219072] 任务B---:&lt;NSThread: 0x60400026bf00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 17:51:24.862091+0800 GCDDemo[2536:219069] 任务A---:&lt;NSThread: 0x60000007a5c0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 17:51:26.863621+0800 GCDDemo[2536:218929] 任务C---:&lt;NSThread: 0x6000000646c0&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-26 17:51:28.864385+0800 GCDDemo[2536:218929] 任务C---:&lt;NSThread: 0x6000000646c0&gt;&#123;number = 1, name = main&#125;</div></pre></td></tr></table></figure>
<h3 id="dispatch-barrier-async"><a href="#dispatch-barrier-async" class="headerlink" title="dispatch_barrier_async"></a>dispatch_barrier_async</h3><p>这个方法有一个很接地气的方法，叫做栅栏方法，听名字大概就能明白意思了，这个方法就是为了把队列中的任务分割开的。</p>
<p>当我们在异步执行的时候，有两组操作，并且只有当第一组操作全部执行完之后再执行第二组操作时就可以用到这个方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">- (void)barrierAsync</div><div class="line">&#123;</div><div class="line">    dispatch_queue_t queue = dispatch_queue_create(&quot;com.example.gcd.changeQueueTarget&quot;, DISPATCH_QUEUE_CONCURRENT);</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务A---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务B---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">    dispatch_barrier_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务C---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务D---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        </div><div class="line">        for(int i = 0 ; i &lt; 2 ; i++)</div><div class="line">        &#123;</div><div class="line">            [NSThread sleepForTimeInterval:2];                      //模拟耗时操作</div><div class="line">            NSLog(@&quot;任务E---:%@&quot;,[NSThread currentThread]);          //打印当前线程</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">2018-03-26 21:24:29.637512+0800 GCDDemo[3423:291454] 任务A---:&lt;NSThread: 0x604000269440&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 21:24:29.637512+0800 GCDDemo[3423:291455] 任务B---:&lt;NSThread: 0x600000465180&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 21:24:31.639796+0800 GCDDemo[3423:291454] 任务A---:&lt;NSThread: 0x604000269440&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 21:24:31.639859+0800 GCDDemo[3423:291455] 任务B---:&lt;NSThread: 0x600000465180&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 21:24:33.641645+0800 GCDDemo[3423:291455] 任务C---:&lt;NSThread: 0x600000465180&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 21:24:35.646223+0800 GCDDemo[3423:291455] 任务C---:&lt;NSThread: 0x600000465180&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 21:24:37.650334+0800 GCDDemo[3423:291455] 任务D---:&lt;NSThread: 0x600000465180&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 21:24:37.650404+0800 GCDDemo[3423:291454] 任务E---:&lt;NSThread: 0x604000269440&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 21:24:39.653433+0800 GCDDemo[3423:291455] 任务D---:&lt;NSThread: 0x600000465180&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 21:24:39.653444+0800 GCDDemo[3423:291454] 任务E---:&lt;NSThread: 0x604000269440&gt;&#123;number = 4, name = (null)&#125;</div></pre></td></tr></table></figure>
<h3 id="dispatch-apply"><a href="#dispatch-apply" class="headerlink" title="dispatch_apply"></a>dispatch_apply</h3><p>通过这个函数，我们可以按照指定次数，将block追加到制定队列中，并等待任务全部执行完之后执行后边的代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)dispatchApply1</div><div class="line">&#123;</div><div class="line">    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</div><div class="line">    </div><div class="line">    dispatch_apply(10, queue, ^(size_t index) &#123;</div><div class="line">        NSLog(@&quot;%ld&quot;,index);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">2018-03-26 21:31:18.887232+0800 GCDDemo[3529:309734] 0</div><div class="line">2018-03-26 21:31:18.887237+0800 GCDDemo[3529:309775] 3</div><div class="line">2018-03-26 21:31:18.887232+0800 GCDDemo[3529:309777] 1</div><div class="line">2018-03-26 21:31:18.887237+0800 GCDDemo[3529:309776] 2</div><div class="line">2018-03-26 21:31:18.887407+0800 GCDDemo[3529:309775] 4</div><div class="line">2018-03-26 21:31:18.887407+0800 GCDDemo[3529:309734] 5</div><div class="line">2018-03-26 21:31:18.887411+0800 GCDDemo[3529:309777] 6</div><div class="line">2018-03-26 21:31:18.887498+0800 GCDDemo[3529:309776] 7</div><div class="line">2018-03-26 21:31:18.887513+0800 GCDDemo[3529:309775] 8</div><div class="line">2018-03-26 21:31:18.887587+0800 GCDDemo[3529:309734] 9</div></pre></td></tr></table></figure>
<p>这个函数可以使用并发队列异步执行所有的任务，所以也可以用来遍历数组中的内容，只是顺序并不会按照数组的下标顺序来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (void)dispatchApply2</div><div class="line">&#123;</div><div class="line">    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</div><div class="line">    </div><div class="line">    NSArray *array = @[@11,@12,@13,@14,@15,@16,@17,@18,@19,@20];</div><div class="line">        </div><div class="line">    dispatch_apply([array count], queue, ^(size_t index) &#123;</div><div class="line">        NSLog(@&quot;%@&quot;,array[index]);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">2018-03-26 21:36:02.094003+0800 GCDDemo[3638:322810] 14</div><div class="line">2018-03-26 21:36:02.094003+0800 GCDDemo[3638:322506] 11</div><div class="line">2018-03-26 21:36:02.094003+0800 GCDDemo[3638:322813] 13</div><div class="line">2018-03-26 21:36:02.094003+0800 GCDDemo[3638:322812] 12</div><div class="line">2018-03-26 21:36:02.094206+0800 GCDDemo[3638:322810] 16</div><div class="line">2018-03-26 21:36:02.094206+0800 GCDDemo[3638:322812] 15</div><div class="line">2018-03-26 21:36:02.094208+0800 GCDDemo[3638:322506] 18</div><div class="line">2018-03-26 21:36:02.094208+0800 GCDDemo[3638:322813] 17</div><div class="line">2018-03-26 21:36:02.094292+0800 GCDDemo[3638:322810] 19</div><div class="line">2018-03-26 21:36:02.094313+0800 GCDDemo[3638:322812] 20</div></pre></td></tr></table></figure>
<h3 id="dispatch-semaphore"><a href="#dispatch-semaphore" class="headerlink" title="dispatch_semaphore"></a>dispatch_semaphore</h3><p>dispatch semaphore 称为GCD中的信号量，是持有计数的信号，当计数为0的时候等待，不可通过，当计数大于等于1时，计数减一且不等待，可通过。</p>
<p>dispatch_semaphore提供了三个函数：</p>
<ul>
<li>dispatch_semaphore_create 创建一个Semphore并初始化信号的总量。</li>
<li>dispatch_semaphore_signal 发送一个信号，让信号总量加1。</li>
<li>dispatch_semaphore_wait 可以使总信号量减1，让信号总量为0时就会一直等待，否则就可以正常执行。</li>
</ul>
<p>dispatch semaphore在开发中主要用于</p>
<ul>
<li>保持线程同步，将异步执行任务转换为同步执行任务</li>
<li>保证线程安全，为线程加锁</li>
</ul>
<h4 id="保持线程同步"><a href="#保持线程同步" class="headerlink" title="保持线程同步"></a>保持线程同步</h4><p>使用dispatch semphore，可以使异步执行的任务转换成同步执行的任务，比如下边代码中，我们添加了一个异步执行的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">- (void)semaphoreSync</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;currentThread---%@&quot;,[NSThread currentThread]);  // 打印当前线程</div><div class="line">    NSLog(@&quot;semaphore---begin&quot;);</div><div class="line">    </div><div class="line">    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</div><div class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);</div><div class="line">    </div><div class="line">    __block int number = 0;</div><div class="line">    </div><div class="line">    //添加异步任务</div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        // 追加任务1</div><div class="line">        [NSThread sleepForTimeInterval:2];              // 模拟耗时操作</div><div class="line">        NSLog(@&quot;%@&quot;,[NSThread currentThread]);      // 打印当前线程</div><div class="line">        </div><div class="line">        number = 100;</div><div class="line">        </div><div class="line">        dispatch_semaphore_signal(semaphore);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">    NSLog(@&quot;semaphore---end,number = %zd&quot;,number);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2018-03-26 21:51:24.444082+0800 GCDDemo[3792:354114] currentThread---&lt;NSThread: 0x60000006ad00&gt;&#123;number = 1, name = main&#125;</div><div class="line">2018-03-26 21:51:24.444267+0800 GCDDemo[3792:354114] semaphore---begin</div><div class="line">2018-03-26 21:51:26.449933+0800 GCDDemo[3792:354277] &lt;NSThread: 0x60000027d540&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 21:51:26.450298+0800 GCDDemo[3792:354114] semaphore---end,number = 100</div></pre></td></tr></table></figure>
<p>但是看到结果，end方法是在最后才执行的，semaphore将异步任务转换成了同步任务。</p>
<h4 id="保证线程安全"><a href="#保证线程安全" class="headerlink" title="保证线程安全"></a>保证线程安全</h4><p>如果我们的应用中，有一个变量，每个线程都可以对他进行读写，那如果多个线程对他同时进行读写，就会影响到线程安全。</p>
<p>举个例子，有两个线程，线程A和线程B，他们同时都要对某个变量进行+1操作，如果此时变量值为10，线程A执行读取操作时，线程B也执行了读取操作，他们又都进行了+1操作，这时候实际上是执行了两次+1,但是，他们将变量写回去时却只加了一次，这就影响了线程安全。</p>
<p>下边用一个火车票售卖的方式来看看线程安全的问题。</p>
<p>比如，一共有50张火车票，共有AB两个售票口，他们同时卖票，直到卖完为止。</p>
<p>非线程安全时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">- (void)semaphoreNotSafe</div><div class="line">&#123;</div><div class="line">    self.ticketNumer = 50;</div><div class="line">    </div><div class="line">    dispatch_queue_t queueA = dispatch_queue_create(&quot;com.example.gcd.notSafeA&quot;, DISPATCH_QUEUE_SERIAL);</div><div class="line">    dispatch_queue_t queueB = dispatch_queue_create(&quot;com.example.gcd.notSafeB&quot;, DISPATCH_QUEUE_SERIAL);</div><div class="line">    </div><div class="line">    __weak ViewController *weakSelf = self;</div><div class="line">    </div><div class="line">    dispatch_async(queueA, ^&#123;</div><div class="line">        [weakSelf saleTicket];</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">    dispatch_async(queueB, ^&#123;</div><div class="line">        [weakSelf saleTicket];</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)saleTicket</div><div class="line">&#123;</div><div class="line">    while (1) &#123;</div><div class="line">        </div><div class="line">        if(self.ticketNumer &gt; 0)</div><div class="line">        &#123;</div><div class="line">            self.ticketNumer--;</div><div class="line">            </div><div class="line">            NSLog(@&quot;%@&quot;, [NSString stringWithFormat:@&quot;剩余票数：%ld 窗口：%@&quot;, self.ticketNumer, [NSThread currentThread]]);</div><div class="line">            [NSThread sleepForTimeInterval:1];</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">            NSLog(@&quot;票已卖完&quot;);</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到打印结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">2018-03-26 22:04:59.329860+0800 GCDDemo[4000:383727] 剩余票数：49 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:04:59.329860+0800 GCDDemo[4000:383728] 剩余票数：48 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:00.334582+0800 GCDDemo[4000:383727] 剩余票数：47 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:00.334571+0800 GCDDemo[4000:383728] 剩余票数：47 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:01.335954+0800 GCDDemo[4000:383728] 剩余票数：46 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:01.335973+0800 GCDDemo[4000:383727] 剩余票数：45 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:02.338000+0800 GCDDemo[4000:383728] 剩余票数：43 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:02.338004+0800 GCDDemo[4000:383727] 剩余票数：44 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:03.340447+0800 GCDDemo[4000:383728] 剩余票数：42 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:03.340447+0800 GCDDemo[4000:383727] 剩余票数：42 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:04.341005+0800 GCDDemo[4000:383727] 剩余票数：40 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:04.341005+0800 GCDDemo[4000:383728] 剩余票数：41 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:05.345193+0800 GCDDemo[4000:383728] 剩余票数：39 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:05.345193+0800 GCDDemo[4000:383727] 剩余票数：38 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:06.345793+0800 GCDDemo[4000:383727] 剩余票数：37 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:06.345793+0800 GCDDemo[4000:383728] 剩余票数：36 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:07.352213+0800 GCDDemo[4000:383727] 剩余票数：35 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:07.352213+0800 GCDDemo[4000:383728] 剩余票数：34 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:08.352845+0800 GCDDemo[4000:383727] 剩余票数：33 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:08.352848+0800 GCDDemo[4000:383728] 剩余票数：32 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:09.353498+0800 GCDDemo[4000:383727] 剩余票数：30 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:09.353502+0800 GCDDemo[4000:383728] 剩余票数：31 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:10.359020+0800 GCDDemo[4000:383727] 剩余票数：29 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:10.359020+0800 GCDDemo[4000:383728] 剩余票数：28 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:11.364586+0800 GCDDemo[4000:383728] 剩余票数：26 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:11.364592+0800 GCDDemo[4000:383727] 剩余票数：27 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:12.369457+0800 GCDDemo[4000:383727] 剩余票数：24 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:12.369457+0800 GCDDemo[4000:383728] 剩余票数：25 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:13.370120+0800 GCDDemo[4000:383728] 剩余票数：22 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:13.370120+0800 GCDDemo[4000:383727] 剩余票数：23 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:14.372062+0800 GCDDemo[4000:383728] 剩余票数：21 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:14.372069+0800 GCDDemo[4000:383727] 剩余票数：21 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:15.372638+0800 GCDDemo[4000:383728] 剩余票数：20 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:15.373013+0800 GCDDemo[4000:383727] 剩余票数：19 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:16.373716+0800 GCDDemo[4000:383727] 剩余票数：18 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:16.373730+0800 GCDDemo[4000:383728] 剩余票数：18 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:17.377931+0800 GCDDemo[4000:383728] 剩余票数：17 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:17.377949+0800 GCDDemo[4000:383727] 剩余票数：16 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:18.383555+0800 GCDDemo[4000:383727] 剩余票数：15 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:18.383571+0800 GCDDemo[4000:383728] 剩余票数：14 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:19.386063+0800 GCDDemo[4000:383728] 剩余票数：13 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:19.386063+0800 GCDDemo[4000:383727] 剩余票数：13 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:20.386737+0800 GCDDemo[4000:383728] 剩余票数：12 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:20.386752+0800 GCDDemo[4000:383727] 剩余票数：12 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:21.389788+0800 GCDDemo[4000:383727] 剩余票数：11 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:21.389793+0800 GCDDemo[4000:383728] 剩余票数：10 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:22.394476+0800 GCDDemo[4000:383727] 剩余票数：9 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:22.394476+0800 GCDDemo[4000:383728] 剩余票数：9 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:23.395737+0800 GCDDemo[4000:383728] 剩余票数：8 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:23.395732+0800 GCDDemo[4000:383727] 剩余票数：7 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:24.401277+0800 GCDDemo[4000:383728] 剩余票数：6 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:24.401277+0800 GCDDemo[4000:383727] 剩余票数：5 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:25.402654+0800 GCDDemo[4000:383728] 剩余票数：4 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:25.402654+0800 GCDDemo[4000:383727] 剩余票数：3 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:26.406315+0800 GCDDemo[4000:383728] 剩余票数：1 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:26.406307+0800 GCDDemo[4000:383727] 剩余票数：2 窗口：&lt;NSThread: 0x60400007ab00&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:05:27.407101+0800 GCDDemo[4000:383728] 剩余票数：0 窗口：&lt;NSThread: 0x60400007adc0&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:05:27.407102+0800 GCDDemo[4000:383727] 票已卖完</div><div class="line">2018-03-26 22:05:28.409874+0800 GCDDemo[4000:383728] 票已卖完</div></pre></td></tr></table></figure>
<p>有很多时候票数是乱的，这样的结果就是线程不安全的情况。</p>
<p>线程安全时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">- (void)semaphoreSafe</div><div class="line">&#123;</div><div class="line">    self.ticketNumer = 50;</div><div class="line">    </div><div class="line">    dispatch_queue_t queueA = dispatch_queue_create(&quot;com.example.gcd.notSafeA&quot;, DISPATCH_QUEUE_SERIAL);</div><div class="line">    dispatch_queue_t queueB = dispatch_queue_create(&quot;com.example.gcd.notSafeB&quot;, DISPATCH_QUEUE_SERIAL);</div><div class="line">    </div><div class="line">    _dispatchSemaphore = dispatch_semaphore_create(1);</div><div class="line"></div><div class="line">    </div><div class="line">    __weak ViewController *weakSelf = self;</div><div class="line">    </div><div class="line">    dispatch_async(queueA, ^&#123;</div><div class="line">        [weakSelf saleTicket];</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">    dispatch_async(queueB, ^&#123;</div><div class="line">        [weakSelf saleTicket];</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)saleTicket</div><div class="line">&#123;</div><div class="line">    while (1) &#123;</div><div class="line">        </div><div class="line">        //加锁</div><div class="line">        dispatch_semaphore_wait(_dispatchSemaphore, DISPATCH_TIME_FOREVER);</div><div class="line">        </div><div class="line">        if(self.ticketNumer &gt; 0)</div><div class="line">        &#123;</div><div class="line">            self.ticketNumer--;</div><div class="line">            </div><div class="line">            NSLog(@&quot;%@&quot;, [NSString stringWithFormat:@&quot;剩余票数：%ld 窗口：%@&quot;, self.ticketNumer, [NSThread currentThread]]);</div><div class="line">            [NSThread sleepForTimeInterval:1];</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">            NSLog(@&quot;票已卖完&quot;);</div><div class="line">            dispatch_semaphore_signal(_dispatchSemaphore);</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        //解锁</div><div class="line">        dispatch_semaphore_signal(_dispatchSemaphore);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">2018-03-26 22:10:45.761891+0800 GCDDemo[4101:403227] 剩余票数：49 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:10:46.766212+0800 GCDDemo[4101:403228] 剩余票数：48 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:10:47.771028+0800 GCDDemo[4101:403227] 剩余票数：47 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:10:48.771842+0800 GCDDemo[4101:403228] 剩余票数：46 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:10:49.772338+0800 GCDDemo[4101:403227] 剩余票数：45 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:10:50.777860+0800 GCDDemo[4101:403228] 剩余票数：44 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:10:51.782705+0800 GCDDemo[4101:403227] 剩余票数：43 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:10:52.785061+0800 GCDDemo[4101:403228] 剩余票数：42 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:10:53.789741+0800 GCDDemo[4101:403227] 剩余票数：41 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:10:54.795152+0800 GCDDemo[4101:403228] 剩余票数：40 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:10:55.799427+0800 GCDDemo[4101:403227] 剩余票数：39 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:10:56.802008+0800 GCDDemo[4101:403228] 剩余票数：38 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:10:57.806299+0800 GCDDemo[4101:403227] 剩余票数：37 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:10:58.806870+0800 GCDDemo[4101:403228] 剩余票数：36 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:10:59.808545+0800 GCDDemo[4101:403227] 剩余票数：35 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:00.809948+0800 GCDDemo[4101:403228] 剩余票数：34 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:01.812548+0800 GCDDemo[4101:403227] 剩余票数：33 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:02.817154+0800 GCDDemo[4101:403228] 剩余票数：32 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:03.819159+0800 GCDDemo[4101:403227] 剩余票数：31 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:04.819982+0800 GCDDemo[4101:403228] 剩余票数：30 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:05.821800+0800 GCDDemo[4101:403227] 剩余票数：29 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:06.825885+0800 GCDDemo[4101:403228] 剩余票数：28 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:07.826912+0800 GCDDemo[4101:403227] 剩余票数：27 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:08.832396+0800 GCDDemo[4101:403228] 剩余票数：26 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:09.835059+0800 GCDDemo[4101:403227] 剩余票数：25 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:10.840474+0800 GCDDemo[4101:403228] 剩余票数：24 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:11.846021+0800 GCDDemo[4101:403227] 剩余票数：23 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:12.851628+0800 GCDDemo[4101:403228] 剩余票数：22 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:13.853427+0800 GCDDemo[4101:403227] 剩余票数：21 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:14.856674+0800 GCDDemo[4101:403228] 剩余票数：20 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:15.861639+0800 GCDDemo[4101:403227] 剩余票数：19 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:16.863499+0800 GCDDemo[4101:403228] 剩余票数：18 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:17.868928+0800 GCDDemo[4101:403227] 剩余票数：17 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:18.869595+0800 GCDDemo[4101:403228] 剩余票数：16 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:19.870315+0800 GCDDemo[4101:403227] 剩余票数：15 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:20.875770+0800 GCDDemo[4101:403228] 剩余票数：14 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:21.881166+0800 GCDDemo[4101:403227] 剩余票数：13 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:22.885946+0800 GCDDemo[4101:403228] 剩余票数：12 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:23.886687+0800 GCDDemo[4101:403227] 剩余票数：11 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:24.887354+0800 GCDDemo[4101:403228] 剩余票数：10 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:25.890562+0800 GCDDemo[4101:403227] 剩余票数：9 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:26.893624+0800 GCDDemo[4101:403228] 剩余票数：8 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:27.899003+0800 GCDDemo[4101:403227] 剩余票数：7 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:28.903570+0800 GCDDemo[4101:403228] 剩余票数：6 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:29.909605+0800 GCDDemo[4101:403227] 剩余票数：5 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:30.915243+0800 GCDDemo[4101:403228] 剩余票数：4 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:31.920318+0800 GCDDemo[4101:403227] 剩余票数：3 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:32.921032+0800 GCDDemo[4101:403228] 剩余票数：2 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:33.926648+0800 GCDDemo[4101:403227] 剩余票数：1 窗口：&lt;NSThread: 0x604000275080&gt;&#123;number = 3, name = (null)&#125;</div><div class="line">2018-03-26 22:11:34.932261+0800 GCDDemo[4101:403228] 剩余票数：0 窗口：&lt;NSThread: 0x600000278900&gt;&#123;number = 4, name = (null)&#125;</div><div class="line">2018-03-26 22:11:35.937217+0800 GCDDemo[4101:403227] 票已卖完</div><div class="line">2018-03-26 22:11:35.937663+0800 GCDDemo[4101:403228] 票已卖完</div></pre></td></tr></table></figure>
<p>这时候就可以看到，票的数量都是按照正常的顺序一张一张减少，也没有出现错乱的问题，这时候就是线程安全的了。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>以上差不多就是GCD的全部内容了，这里也只是多线程开发的一小部分，写这一部分的大神也有很多，这篇文章很多内容都是参考自他们的博客，还有一部分来自于《Objective-C 高级编程》的第三章，本文章仅限个人学习使用，如果有什么不对的地方还请大佬们多多指教。</p>
<p>啊，对了，最后还是放一个demo<a href="https://github.com/rshinich/GCDDemo" target="_blank" rel="external">地址</a>吧。</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="">Objective-C 高级编程 - 第三章 Grand Central Dispatch</a></p>
<p><a href="https://www.jianshu.com/p/ae786a4cf3b1" target="_blank" rel="external">iOS中GCD的使用小结</a></p>
<p><a href="https://juejin.im/post/5a38820cf265da431281082e#heading-8" target="_blank" rel="external">iOS多线程GCD篇</a></p>
<p><a href="https://bujige.net/blog/iOS-Complete-learning-GCD.html" target="_blank" rel="external">iOS多线程：『GCD』详尽总结</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/20/iOS开发-面试知识点整理/" rel="next" title="iOS开发-面试知识点整理">
                <i class="fa fa-chevron-left"></i> iOS开发-面试知识点整理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/28/iOS开发-RunLoop/" rel="prev" title="iOS开发-RunLoop">
                iOS开发-RunLoop <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="zhangzr" />
          <p class="site-author-name" itemprop="name">zhangzr</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">85</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#GCD是什么"><span class="nav-number">1.</span> <span class="nav-text">GCD是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多线程编程"><span class="nav-number">2.</span> <span class="nav-text">多线程编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#进程"><span class="nav-number">2.1.</span> <span class="nav-text">进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程"><span class="nav-number">2.2.</span> <span class="nav-text">线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主线程"><span class="nav-number">2.3.</span> <span class="nav-text">主线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任务"><span class="nav-number">2.4.</span> <span class="nav-text">任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#同步"><span class="nav-number">2.5.</span> <span class="nav-text">同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步"><span class="nav-number">2.6.</span> <span class="nav-text">异步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#队列"><span class="nav-number">2.7.</span> <span class="nav-text">队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#串行"><span class="nav-number">2.8.</span> <span class="nav-text">串行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#并发"><span class="nav-number">2.9.</span> <span class="nav-text">并发</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GCD的使用"><span class="nav-number">3.</span> <span class="nav-text">GCD的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#找到适当的等待队列"><span class="nav-number">3.1.</span> <span class="nav-text">找到适当的等待队列</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-queue-create"><span class="nav-number">3.1.1.</span> <span class="nav-text">dispatch_queue_create</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Main-Dispatch-Queue-（主队列）"><span class="nav-number">3.1.2.</span> <span class="nav-text">Main Dispatch Queue （主队列）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Global-Dispatch-Queue（全局并发队列）"><span class="nav-number">3.1.3.</span> <span class="nav-text">Global Dispatch Queue（全局并发队列）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将任务追加到等待队列中"><span class="nav-number">3.2.</span> <span class="nav-text">将任务追加到等待队列中</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GCD的使用实例"><span class="nav-number">4.</span> <span class="nav-text">GCD的使用实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#同步执行-并发队列"><span class="nav-number">4.1.</span> <span class="nav-text">同步执行 + 并发队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步执行-并发队列"><span class="nav-number">4.2.</span> <span class="nav-text">异步执行 + 并发队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#同步执行-串行队列"><span class="nav-number">4.3.</span> <span class="nav-text">同步执行 + 串行队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步执行-串行队列"><span class="nav-number">4.4.</span> <span class="nav-text">异步执行 + 串行队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#同步执行-主队列"><span class="nav-number">4.5.</span> <span class="nav-text">同步执行 + 主队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步执行-主线程"><span class="nav-number">4.6.</span> <span class="nav-text">异步执行 + 主线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">4.7.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GCD-的其他API"><span class="nav-number">5.</span> <span class="nav-text">GCD 的其他API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-set-target-queue"><span class="nav-number">5.1.</span> <span class="nav-text">dispatch_set_target_queue</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#改变队列的优先级"><span class="nav-number">5.1.1.</span> <span class="nav-text">改变队列的优先级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#防止多个串行队列并发执行"><span class="nav-number">5.1.2.</span> <span class="nav-text">防止多个串行队列并发执行</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-after"><span class="nav-number">5.2.</span> <span class="nav-text">dispatch_after</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-once"><span class="nav-number">5.3.</span> <span class="nav-text">dispatch_once</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-group"><span class="nav-number">5.4.</span> <span class="nav-text">dispatch_group</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-group-notify"><span class="nav-number">5.4.1.</span> <span class="nav-text">dispatch_group_notify</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-group-wait"><span class="nav-number">5.4.2.</span> <span class="nav-text">dispatch_group_wait</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-group-enter-dispatch-group-leave"><span class="nav-number">5.4.3.</span> <span class="nav-text">dispatch_group_enter + dispatch_group_leave</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-barrier-async"><span class="nav-number">5.5.</span> <span class="nav-text">dispatch_barrier_async</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-apply"><span class="nav-number">5.6.</span> <span class="nav-text">dispatch_apply</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-semaphore"><span class="nav-number">5.7.</span> <span class="nav-text">dispatch_semaphore</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#保持线程同步"><span class="nav-number">5.7.1.</span> <span class="nav-text">保持线程同步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#保证线程安全"><span class="nav-number">5.7.2.</span> <span class="nav-text">保证线程安全</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最后"><span class="nav-number">6.</span> <span class="nav-text">最后</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-number">7.</span> <span class="nav-text">参考文档</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhangzr</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  






  





  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":100,"height":200},"mobile":{"show":true},"react":{"opacityDefault":1,"opacityOnHover":0.2}});</script></body>
</html>
